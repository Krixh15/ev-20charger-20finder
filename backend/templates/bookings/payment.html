{% extends 'base.html' %}
{% block title %}Payment{% endblock %}
{% block content %}
<h2>Complete Payment</h2>
<p>Booking #{{ booking.pk }} — Amount: ₹{{ booking.amount }}</p>
<button id="rzp-button" class="btn btn-success">Pay Now</button>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const options = {
    key: '{{ razorpay_key }}',
    amount: '{{ amount }}',
    currency: 'INR',
    name: 'EV Share',
    description: 'Booking payment',
    order_id: '{{ order_id }}',
    handler: function (response){
      // Send payment confirmation to server
      fetch('{% url "bookings:payment_callback" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
        body: `booking_id={{ booking.pk }}&razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}`
      }).then(r => r.json()).then(data => {
        if (data.status === 'ok') {
          window.location.href = '{% url "bookings:thankyou" booking.pk %}';
        } else alert('Payment verification failed');
      });
    }
  };
  document.getElementById('rzp-button').addEventListener('click', function(e){
    const rzp = new Razorpay(options);
    rzp.open();
    e.preventDefault();
  });
</script>
{% endblock %}
